# https://help.github.com/en/categories/automating-your-workflow-with-github-actions

name: "PHPUnit tests"

on:
    pull_request:
    push:

jobs:
    phpunit:
        name: "PHPUnit tests"

        runs-on: ${{ matrix.operating-system }}

        strategy:
            matrix:
                dependencies:
                    - "lowest"
                    - "highest"
                    - "locked"
                php-version:
                    - "8.2"
                    - "8.3"
                operating-system:
                    - "ubuntu-latest"
                    - "windows-latest"

        steps:
            - name: "Checkout"
              uses: "actions/checkout@v4"

            - name: "Install PHP"
              uses: "shivammathur/setup-php@2.31.0"
              with:
                  coverage: "pcov"
                  php-version: "${{ matrix.php-version }}"
                  ini-values: memory_limit=-1

            - name: Get Composer cache directory
              id: composer-cache
              run: echo "::set-output name=dir::$(composer config cache-dir)"

            - name: Cache dependencies
              uses: actions/cache@v4
              with:
                path: ${{ steps.composer-cache.outputs.dir }}
                key: composer-${{ runner.os }}-${{ matrix.php-version }}-${{ hashFiles('composer.*') }}-${{ matrix.dependencies }}
                restore-keys: |
                  composer-${{ runner.os }}-${{ matrix.php-version }}-${{ hashFiles('composer.*') }}-
                  composer-${{ runner.os }}-${{ matrix.php-version }}-
                  composer-${{ runner.os }}-
                  composer-

            - name: "Install lowest dependencies"
              if: ${{ matrix.dependencies == 'lowest' }}
              run: "composer update --prefer-lowest --no-interaction --no-progress --no-suggest"

            - name: "Install highest dependencies"
              if: ${{ matrix.dependencies == 'highest' }}
              run: "composer update --no-interaction --no-progress --no-suggest"

            - name: "Install locked dependencies"
              if: ${{ matrix.dependencies == 'locked' }}
              run: "composer install --no-interaction --no-progress --no-suggest"

            - name: "Compile PHAR"
              run: |
                php -d phar.readonly=0 vendor/bin/phing phar-build
                # We re-run 'composer install' here as phing runs 'composer install --no-dev'.
                # Using 'install' (not 'update' with flags) here is correct as the previous update re-wrote wrote the lock file.
                composer --no-interaction install --no-progress

            - name: "Tests"
              run: "vendor/bin/phpunit --coverage-clover=clover.xml --coverage-text"
